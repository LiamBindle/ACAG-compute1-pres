<!doctype html>
<html>
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

		<title>ACAG Forum 2020-02-21</title>

		<link rel="stylesheet" href="css/reset.css">
		<link rel="stylesheet" href="css/reveal.css">
		<link rel="stylesheet" href="css/theme/black.css">

		<!-- Theme used for syntax highlighting of code -->
		<link rel="stylesheet" href="lib/css/monokai.css">
		<link href='https://fonts.googleapis.com/css?family=Montserrat' rel='stylesheet'>
		<link href="//fonts.googleapis.com/css?family=Lato:300,900" rel="stylesheet">

		<!-- Printing and PDF exports -->
		<script>
			var link = document.createElement( 'link' );
			link.rel = 'stylesheet';
			link.type = 'text/css';
			link.href = window.location.search.match( /print-pdf/gi ) ? 'css/print/pdf.css' : 'css/print/paper.css';
			document.getElementsByTagName( 'head' )[0].appendChild( link );
		</script>
	</head>
	<body>
		<div class="reveal">
			<div class="slides">


				<!-- Slide 1 -->
				<section>
					<h2 style="text-align: center;">Stretched-grid, CMake, and Continuous Integration Developments in GCHP</h2>
					<h4 style="text-align: center; padding: 0; margin: 0;">Liam Bindle</h4>
					<h4 style="text-align: center; padding: 0; margin: 0;">2020-01-29</h4>
				</section>

				<!-- Slide 2 -->
				<section>
					<h2 style="text-align: center;">Concepts and terminology</h2>
				</section>

				<section>
					<img data-src="img/you-head-exec.svg">
				</section>

				<section>
					<section>
						<h3>Concepts and terminology&mdash;don't over think it</h3>
						<ul>
							<li><strong>Nodes</strong>&mdash;there's a head-node and many exec-nodes</li>
							<li><strong>Scheduler</strong>&mdash;LSF (IBM) is the scheduler; you use commands like <code>bsub</code></li>
							<li><strong>Job/Job script</strong>&mdash;a bash script that gets run on an exec-node</li>
							<li><strong>Interactive job</strong>&mdash;a job that gets you a terminal on an exec-node</li>
							<li><strong>Batch job</strong>&mdash;a bash script that gets run on an exec-node</li>
							<li><strong>Container</strong>&mdash;the preconfigured environment your job script runs in</li>
						</ul>
					</section>
					<section>
						<pre><code data-trim class="bash" data-noescape>
							#!/usr/bin/env bash
							#BSUB -q rvmartin
							#BSUB -n 16
							#BSUB -W 168:00
							#BSUB -R "rusage[mem=40000] span[hosts=1]"
							#BSUB -a 'docker(registry.gsc.wustl.edu/sleong/base-engineering)'
							#BSUB -J "Example 1-year 2x2.5 GEOS-Chem simulation"
							#BSUB -N
							#BSUB -u liam.bindle@wustl.edu
							#BSUB -o job-%J-output.txt

							# Set up runtime environment
							set -x                                      # Print executed commands
							set -e                                      # Exit immediately if a command fails
							ulimit -s unlimited                         # Make max stack size large
							export OMP_STACKSIZE=500m                   # Make max stack size of threads large
							export OMP_NUM_THREADS=$LSB_DJOB_NUMPROC    # Set num threads based on bsub's -n argument

							# Execute simulation
							cd /my-projects/geos-chem-example/geosfp_2x25_standard   # cd into run directory
							./geos                                                   # Execute GEOS-Chem				
						</code></pre>
					</section>
				</section>

				<section>
					<h2 style="text-align: center;">What we're going to go over</h2>
					<div style="text-align: center;">
					<ol>
						<li>How to get help</li>
						<li>Logging in and some initial set up</li>
						<li>The directory structure on the head-node</li>
						<li>Using <code>bsub</code> to submit jobs</li>
						<li>Job scripts (interactive and batch)</li>
						<li>The directory structure on exec-nodes</li>
						<li>Other <code>b</code>-commands to interact with LSF</li>
						<li>The magic that was done in the initial set up</li>
					</ol>
				</div>
				</section>
				
				<section>
					<h2>Getting help</h2>
					<ul>
						<li>RIS User Manual: <a href="https://confluence.ris.wustl.edu/display/RSUM/User+Manual"><br>https://confluence.ris.wustl.edu/display/RSUM/User+Manual</a></li>
						<li>Submit a ticket with RIS: <a href="https://jira.ris.wustl.edu/servicedesk/customer/portal/1/group/22"><br>https://jira.ris.wustl.edu/servicedesk/customer/portal/1/group/22</a></li>
						<li>LSF Command Reference: <a href="https://www.ibm.com/support/knowledgecenter/SSETD4_9.1.2/lsf_command_ref/bsub.1.html"><br><small>https://www.ibm.com/support/knowledgecenter/SSETD4_9.1.2/lsf_command_ref/bsub.1.html</small></a></li>
						<li><code>bsub</code> options (in LSF Command Reference): <a href="https://www.ibm.com/support/knowledgecenter/SSWRJV_10.1.0/lsf_command_ref/bsub.heading_options.1.html"><br><small>https://www.ibm.com/support/knowledgecenter/SSWRJV_10.1.0/lsf_command_ref/bsub.heading_options.1.html</small></a></li>
					</ul>
				</section>

				<section>
					<section>
						<h2>Logging in and initial set up</h2>
						<ol>
							<li>Modify <code>~/.ssh/config</code></li>
							<li>Log in to compute1 with <code>ssh compute1</code></li>
							<li>Run a set up script I wrote</li>
						</ol>
					</section>
					<section>
						<div>
							<p>Edit <code>~/.ssh/config</code></p>
							<pre><code data-trim class="shell" data-noescape>
								$ vim ~/.ssh/config
							</code></pre>
						</div>

						<div class="fragment fade-in">
							<p> Add the following lines (use your WUSTL key)</p>
							<pre><code data-trim class="plaintext" data-noescape>
								Host compute1
									HostName compute1-client-1.ris.wustl.edu
									User liam.bindle
							
							</code></pre>
						</div>

						<div class="fragment fade-in">
							<p>Log in to compute1</p>
							<pre><code data-trim class="shell" data-noescape>
								$ ssh compute1
							</code></pre>
						</div>

						<div class="fragment fade-in">
							<p>Run this snippet to set some things up</p>
							<pre><code data-trim class="bash" data-noescape>
								cd ~
								wget -qO- https://github.com/Atmospheric-Composition-Analysis-Group/compute1/archive/master.tar.gz | tar -xzf -
								mv compute1-master compute1
								echo "source $HOME/compute1/head-node.rc" >> $HOME/.bashrc
							</code></pre>
						</div>

						<div class="fragment fade-in">
							<p>Log out</p>
							<pre><code data-trim class="shell" data-noescape>
								[liam.bindle@compute1-client-1 ~]$ exit
							</code></pre>
						</div>
						<div class="fragment fade-in">
							<p>... and then back in</p>
							<pre><code data-trim class="shell" data-noescape>
								$ ssh compute1
							</code></pre>
						</div>
					</section>
				</section>

				<section>
					<section>
						<h2>Directories on the head-node</h2>
						<div style="font-size: 11pt;">
							<ul>
								<li><code>/home/IDC-ID-74944</code> &mdash; my home directory</li>
								<li><code>/home/IDC-ID-74944/compute1</code> &mdash; some environment and jobs scripts to help get you started </li>
								<li><code>/storage1/fs1/rvmartin/Active</code> &mdash; our group's root directory</li>
								<li><code>/storage1/fs1/rvmartin/Active/Shared</code> &mdash; a shared read/write directory</li>
								<li><code>/storage1/fs1/rvmartin/Active/bindle</code> &mdash; my personal projects directory</li>
								<li><code>/storage1/fs1/rvmartin/Active/GEOS-Chem-shared/ExtData</code> &mdash; GEOS-Chem's ExtData directory</li>
							</ul>
						</div>
					</section>
					<section>
						Create these links
						<pre><code data-trim class="shell" data-noescape>
							[liam.bindle@compute1-client-1 ~]$ ln -s /storage1/fs1/rvmartin/Active/bindle my-projects
							[liam.bindle@compute1-client-1 ~]$ ln -s /storage1/fs1/rvmartin/Active/Shared Shared
						</code></pre>
					</section>
				</section>
				
				<section>
					<section>
						<h2>Launching jobs with <code>bsub</code></h2>
						<ul>
							<li>Jobs are submitted with the <code>bsub</code> command</li>
							<li>Options can be specified on the command-line or in your job script</li>
							<li>There are lots of options so it's <strong>alot</strong> easier to do it in your job script</li>
						</ul>
					</section>
					<section>
						<p>Try launching <code>~/compute1/interactive.sh</code></p>
						<pre><code data-trim class="bash" data-noescape>
							[liam.bindle@compute1-client-1 ~]$ bsub < compute1/interactive.sh
						</code></pre>
						<div class="fragment fade-in" style="text-align: center;">
							<p style="display: inline-block; text-align: left;">We'll look at the contents of jobs scritps, but first lets look <br>at the directory structure on exec-nodes</p>
						</div>
					</section>
				</section>

				<section>
					<h2>Directories on the exec-nodes</h2>
					<div style="font-size: 11pt;">
						<ul>
							<li><code>/my-projects</code> &mdash; my personal projects directory</li>
							<li><code>/ExtData</code> &mdash; the shared read/write directory</li>
							<li><code>/ExtData</code> &mdash; GEOS-Chem's ExtData directory</li>
							<li><code>/home/IDC-ID-74944</code> &mdash; my home directory (same directory as head-node)</li>
						</ul>
					</div>
				</section>

				<section>
					<h2>Job scripts: an interactive job</h2>
					<pre><code data-trim class="bash" data-noescape>
						#!/bin/bash
						#BSUB -Is
						#BSUB -n 8
						#BSUB -R "rusage[mem=40000] span[hosts=1]"
						#BSUB -q rvmartin-interactive
						#BSUB -a 'docker(registry.gsc.wustl.edu/sleong/base-engineering)'

						source $HOME/compute1/compute-node.rc
						cd /my-projects
						zsh
					</code></pre>
				</section>

				<section>
					<h2>Job scripts: a batch job</h2>
					<pre><code data-trim class="bash" data-noescape>
						#!/usr/bin/env bash
						#BSUB -q rvmartin
						#BSUB -n 16
						#BSUB -W 168:00
						#BSUB -R "rusage[mem=40000] span[hosts=1]"
						#BSUB -a 'docker(registry.gsc.wustl.edu/sleong/base-engineering)'
						#BSUB -J "Example 1-year 2x2.5 GEOS-Chem simulation"
						#BSUB -N
						#BSUB -u liam.bindle@wustl.edu
						#BSUB -o job-%J-output.txt

						# Set up runtime environment
						set -x                                      # Print executed commands
						set -e                                      # Exit immediately if a command fails
						ulimit -s unlimited                         # Make max stack size large
						export OMP_STACKSIZE=500m                   # Make max stack size of threads large
						export OMP_NUM_THREADS=$LSB_DJOB_NUMPROC    # Set num threads based on bsub's -n argument

						# Execute simulation
						cd /my-projects/geos-chem-example/geosfp_2x25_standard   # cd into run directory
						./geos                                                   # Execute GEOS-Chem
					</code></pre>
				</section>

				<!-- Slide 10 -->
				<section>
					<h2 style="text-align: center;">Thanks!</h2>
				</section>

			</div>
		</div>

		<script src="js/reveal.js"></script>

		<script>
			// More info about config & dependencies:
			// - https://github.com/hakimel/reveal.js#configuration
			// - https://github.com/hakimel/reveal.js#dependencies
			Reveal.initialize({
				hash: true,
				dependencies: [
					{ src: 'plugin/markdown/marked.js' },
					{ src: 'plugin/markdown/markdown.js' },
					{ src: 'plugin/highlight/highlight.js' },
					{ src: 'plugin/notes/notes.js', async: true }
				]
			});
		</script>
	</body>
</html>
